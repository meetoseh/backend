# journey_share_link_views

A row is added to this table when someone goes to a share link
generated by another user. Inserts into this table may be cached
in redis for a brief while.

## Fields

- `id (integer primary key)`: Primary stable row identifier
- `uid (text unique not null)`: Primary stable external row identifier.
  Uses to [uid prefix](../uid_prefixes.md) `jslv`
- `journey_share_link_id (integer not null references journey_share_links(id) on delete cascade)`: the link that was clicked
- `user_id (integer null references users(id) on delete set null)`: the
  user who clicked the link, if known and not since deleted
- `visitor_id (integer null references visitors(id) on delete set null)`:
  the visitor who clicked the link, if known and not since deleted
- `user_set (boolean null)`: true if, when this view was confirmed, a user was
  available. used to distinguish if `user_id` was set but then the user was deleted,
  vs the `user_id` was never set. null iff `confirmed_at` is null
- `visitor_set (boolean null)`: true if, when this view was confirmed, a visitor
  was available. used to distinguish if `visitor_id` was set but then the visitor
  was deleted, vs the `visitor_id` was never set. null iff `confirmed_at` is null
- `visitor_was_unique (boolean null)`: true if, when this view was confirmed, a
  visitor was available and had not already seen a share link on the same day,
  with days delineated by `America/Los_Angeles`. This field should be used as the
  primary discriminator for "unique views", both for performance and consistency.
  This does mean if the same user views it on two devices, they get two unique views,
  even if we identified them as the same user.
- `created_at (real not null)`: when the link was viewed, in seconds
  since the epoch
- `confirmed_at (real null)`: if the view was confirmed, augmenting the user sub and
  visitor, the time it was confirmed in seconds since the epoch, otherwise null

## Schema

```sql
CREATE TABLE journey_share_link_views (
    id INTEGER PRIMARY KEY,
    uid TEXT UNIQUE NOT NULL,
    journey_share_link_id INTEGER NOT NULL REFERENCES journey_share_links(id) ON DELETE CASCADE,
    user_id INTEGER NULL REFERENCES users(id) ON DELETE SET NULL,
    visitor_id INTEGER NULL REFERENCES visitors(id) ON DELETE SET NULL,
    user_set BOOLEAN NULL,
    visitor_set BOOLEAN NULL,
    visitor_was_unique BOOLEAN NULL,
    created_at REAL NOT NULL,
    confirmed_at REAL NULL
);

/* Foreign key, lookup */
CREATE INDEX journey_share_link_views_link_id_idx ON journey_share_link_views(journey_share_link_id, visitor_was_unique);

/* Foreign key */
CREATE INDEX journey_share_link_views_user_id_idx ON journey_share_link_views(user_id);

/* Foreign key */
CREATE INDEX journey_share_link_views_visitor_id_idx ON journey_share_link_views(visitor_id);
```

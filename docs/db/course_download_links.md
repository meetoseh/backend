# course_download_links

Users are emailed a link to download their course in full. The link does not
require that they login, since they are not required to create an account to
use the course (though if they don't, they don't have access to any streaming
capabilities).

This makes it more difficult to revoke the link. This tries to include enough
information that the links can be manually revoked under the idea that at this
time it's not that likely we'll need to revoke it, plus we have access to the
link tracking via `course_download_link_clicks`.

## Fields

- `id (integer primary key)`: Internal row identifier
- `uid (text unique not null)`: Primary stable external row identifier.
  Uses the [uid prefix](../uid_prefixes.md) `cdl`.
- `course_id (integer not null references courses(id) on delete cascade)`:
  the course this link is for
- `code (text unique not null)`: The code that is included in the url.
  This is typically a long random identifier, generated by
  `secrets.token_urlsafe(64)`, since these links don't expire.
- `stripe_checkout_session_id (text null)`: The stripe checkout session
  that was used when this link was created, if available. The flow
  in mind for when this is set is:
  - User goes to oseh.com/dylan-bundle (or whatever the purchase page is)
  - User clicks and goes to the stripe checkout page for the dylan-bundle
  - User lands on oseh.io/course-checkout-success?slug={slug}&session={session}
  - The frontend forwards the session id to the backend
  - The backend verifies that session id and gets the basic user details from stripe
  - The backend creates a guest revenue cat account and creates the purchase on it,
    getting back the entitlements for the user.
  - For each course the guest account is entitled to...
    - The email address is upserted into klaviyo, setting the custom property
      `course_link_{slug}` to `https://oseh.io/courses/download?code={code}`
    - Put them beta subscribed
  - User logs in
  - Frontend again forwards the session id to the backend, now with their user jwt
  - Backend sends the purchase to revenue cat for the Oseh accounts revenue cat id,
    this time with the restore flag set. This should remove the entitlements
    from the guest account and add them to the users account.
- `payment_email (text null)`: If the user specified an email during the payment process,
  the email they specified. This may differ from the email they eventually create an account
  with.
- `revenue_cat_id (text null)`: If we have a purchase identifier, such as the checkout
  session id, and we associated that with a revenue cat account in the process of making
  this link, the id of the revenue cat customer that was created. Note that this account
  is expected to lose the entitlement as it will be transferred to a non-guest account.
  This is primarily used for debugging, analytics, and recovery if there are bugs.
- `user_id (integer null references users(id) on delete set null)`: If we know which
  user this course download link is for, that user. This is primarily for analytics,
  and may be set after the fact. However -- the user deleting their account should not
  deactivate this link.
- `visitor_id (integer null references visitors(id) on delete set null)`: If a visitor
  was available when this link was created, the id of that visitor, otherwise null.
  This is primarily for analytics and fraud detection.
- `created_at (real not null)`: When this record was first created.

## Schema

```sql
CREATE TABLE course_download_links (
    id INTEGER PRIMARY KEY,
    uid TEXT UNIQUE NOT NULL,
    course_id INTEGER NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
    code TEXT UNIQUE NOT NULL,
    stripe_checkout_session_id TEXT NULL,
    payment_email TEXT NULL,
    user_id INTEGER NULL REFERENCES users(id) ON DELETE SET NULL,
    visitor_id INTEGER NULL REFERENCES visitors(id) ON DELETE SET NULL,
    created_at REAL NOT NULL
);

/* Foreign key, search */
CREATE INDEX course_download_links_course_id_idx ON course_download_links(course_id);

/* Search */
CREATE INDEX course_download_links_stripe_checkout_session_id_idx ON course_download_links(stripe_checkout_session_id);

/* Search */
CREATE INDEX course_download_links_payment_email_idx ON course_download_links(payment_email);

/* Foreign key, search */
CREATE INDEX course_download_links_user_id_idx ON course_download_links(user_id);

/* Foreign key, search */
CREATE INDEX course_download_links_visitor_id_idx ON course_download_links(visitor_id);
```
